<?php

function ows_preprocess_html(&$variables) {
	$variables['page']['#attached']['library'][] = 'modal/modal';
	$variables['page']['#attached']['library'][] = 'core/drupal.ajax';
}

function ows_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
	if($form_id == "user_register_form") {
		//kint($form);
		/*$form['#attached']['library'][] = 'core/drupal.dialog.ajax';
		
		$form['actions'] = array();
		$form['actions']['#type'] = 'actions';
        $form['actions']['submit'] = array(
            '#type' => 'submit',
            '#value' => 'Register',
            '#ajax' => array(
                //'callback' => '::submitForm'
            )
        );*/
	}

	if ($form_id == "views_exposed_form" && $form['#id'] == "views-exposed-form-browse-page-browse") {
		// kint($form);
	}
}

function ows_views_query_alter(Drupal\views\ViewExecutable $view, Drupal\views\Plugin\views\query\Sql $query) {
	// filter by age
	// unset default where condition of birthday
	unset($query->where[1]['conditions'][1]);
	
	if (isset($_POST['age'])) {
		$configuration = [
			'table' => 'user__field_birthday',
			'field' => 'entity_id',
			'left_table' => 'users_field_data',
			'left_field' => 'uid',
			'operator' => '='
	    ];

	    $year = date('Y') - $_POST['age'];

		$join = \Drupal\views\Views::pluginManager('join')->createInstance('standard', $configuration);
		$query->addRelationship('user__field_birthday', $join, 'users_field_data');
		$query->addWhere(count($query->where), 'user__field_birthday.field_birthday_value', array("$year-01-01", "$year-12-31"), "BETWEEN");
		//$query->addWhere(count($query->where), 'user__field_birthday.field_birthday_value', "$year-01-01", ">=");
		//dpm($query);
	}
}

function ows_mail($key, &$message, $params) {
	$options = array(
		'langcode' => $message['langcode'],
	);

	switch ($key) {
		case 'invite_friend':
			$message['from'] = \Drupal::config('system.site')->get('mail');
			$message['subject'] = t('Article created: @title', array('@title' => $params['node_title']), $options);
			$message['body'][] = $params['message'];
		break;
	}

	switch ($key) {
		// send email to owner when someone submit Add Me form
		case 'add_me':
			$message['from'] = \Drupal::config('system.site')->get('mail');
			$message['subject'] = t('@title', array('@title' => $params['title']), $options);
			$message['body'][] = $params['message'];
		break;

		// send thanks email to sender
		case 'add_me_sender':
			$message['from'] = \Drupal::config('system.site')->get('mail');
			$message['subject'] = t('@title', array('@title' => $params['title']), $options);
			$message['body'][] = $params['message'];
		break;
	}
}
